(in-package :gui)

(defprim form% (name schema element)
  (:pretty () (list 'form (list :name name :schema (synth :pretty schema) 
                                :element (synth :pretty element))))
  (:req (path) (html:taglist 
                (doc:text "Form identificato con ~a collegato al seguente formato dati:" (lower-camel name)) 
                (html:p (synth :req schema))
                (synth :req element path)
                (html:p (doc:text "Esso produce il seguente oggetto JSON:")
                        (html:code (synth :string (synth :model this))))))
  (:brief (path) (synth :req this path))
  (:model () (apply #'jobject (apply #'append (synth-all :model bindings))))
  (:reqlist (*) nil)
  (:template () (html:tag (string-downcase name) (doc:empty)))
  (:controller () (ts-empty))
  (:components (father) 
               (let ((unit-name 
                      (if father 
                          (symb father "-" name)
                          name))
                     (template 
                      (ts-template 
                       (html:form 
                        ;; (keyw (synth :string (doc:brackets (doc:text "~a" (lower-camel (synth :type element))))))
                        :|[formGroup]| (lower-camel name)
                        (synth :form-template element name nil))))
                     (controller 
                      (list (ts-pair name (synth :type element))
                            (ts-constructor (list (ts-pair 'fb (ts-object-type 'form-builder) :private t))
                                            (ts-assign (ts-chain (ts-dynamic 'this) (ts-dynamic name))
                                                       (synth :form element)
                                                       ;; (ts-chain (ts-dynamic 'this) (ts-dynamic 'fb)
                                                       ;;           (ts-call 'group 
                                                       ;;                    (ts-object (keyw (synth :name element)) 
                                                       ;;                               (synth :form element))))
                                                       ))
                            (synth :form-controller element (list (list* name 'form-group)))))) 
                 (list (ts-unit unit-name
                                (ts-import "@angular/core" 'component)
                                (ts-import "@angular/forms" 'form-array 'form-builder 'form-group 'form-control)
                                (synth :ts-imports this)
                                (ts-annotation 'component
                                              :selector (ts-const (string-downcase name))
                                              :template template )
                                (ts-class (mkstr unit-name "-component")
                                          :fields controller)))))
  (:routes (*) nil)
  (:ts-imports () (synth :ts-imports element))
  (:dependencies () (synth :dependencies element)))

(defmacro form (name schema binds elem)
  `(let* ,(mapcar #'(lambda (bind)
		      (destructuring-bind (name key elem) bind
			`(,name (bnd ',key ,elem))))
		  binds) 
     (form% ,name ,schema (obj% ,name ,schema (list ,@(mapcar #'car binds)) ,elem))))

(defprim bnd (name element)
  (:pretty () (list 'bnd (list :name name :element (synth :pretty element))))
  (:req (path) (html:div nil (synth :req element path)))
  (:brief (path) (synth :req this path))
  (:model () (list (keyw name) (synth :model element)))
  (:reqlist (*) nil)
  (:form-template (loopvar indexes) (synth :form-template element loopvar indexes))
  (:form-controller (path) (synth :form-controller element path))
  (:components (*) nil)
  (:routes (*) nil)
  (:form () (list (keyw name) (synth :form element)))
  (:type () (error "should not be visible"))
  (:ts-imports () (synth :ts-imports element))
  (:dependencies () (synth :dependencies element)))

(defprim obj% (name schema bindings element)
  (:pretty () (list 'obj (list :name name :schema (synth :pretty schema) 
                               :bindings (synth-plist-both :pretty :pretty bindings) 
                               :element (synth :pretty element))))
  (:req (path) (html:taglist 
                (doc:text "Sezione identificata con ~a collegata al seguente formato dati:" (lower-camel name)) 
                (html:a :href (concatenate 'string "#" (synth :string (synth :brief schema) 0))
                        (synth :brief schema))
                ;; (html:p (synth :brief schema))
                (synth :req element path)
                (html:p (doc:text "Essa produce il seguente oggetto JSON:")
                        (html:code (synth :string (synth :model this))))))
  (:brief (path) (synth :req this))
  (:model () (apply #'jobject (apply #'append (synth-all :model bindings))))
  (:reqlist (*) nil)
  (:form-template (loopvar indexes) (html:taglist (synth-all :form-template bindings loopvar indexes)))
  (:form-controller (path) (ts-concat (synth-all :form-controller bindings path ;; (append path (list (list* name 'form-group)))
                                               )))
  (:components (*) nil)
  (:routes (*) nil)
  (:form () (ts-new 'form-group (ts-object (apply #'append (synth-all :form bindings))))
         ;; (ts-chain (ts-dynamic 'this) (ts-dynamic 'fb)
         ;;              (ts-call 'group (ts-object (apply #'append (synth-all :form bindings)))))
         )
  (:type () (ts-object-type 'form-group))
  (:ts-imports () (cons (ts-import (mkstr "./" (string-downcase (synth :name schema))) (synth :name schema))
                     (apply #'append 
                       (synth-plist-merge (lambda (pair)
                                            (synth :ts-imports (cadr pair)))
                                          bindings))))
  (:dependencies () (synth :dependencies element)))

(defmacro obj (name schema binds elem)
  `(let* ,(mapcar #'(lambda (bind)
		      (destructuring-bind (name key elem) bind
			`(,name (bnd ',key ,elem))))
		  binds) 
     (let ((f (obj% ,name ,schema (list ,@(mapcar #'car binds)) ,elem))) 
       (values f f))))

(defprim arr% (name schema element)
  (:pretty () (list 'arr (list :name name 
                               :schema (synth :pretty schema) 
                               :element (synth :pretty element))))
  (:req (path) (html:taglist 
                (doc:text "Sezione dinamica identificata con ~a collegata al seguente formato dati:" (lower-camel name)) 
                (html:p (synth :brief schema)) 
                (synth :req element path)
                (html:p (doc:text "Essa produce il seguente oggetto JSON:")
                        (html:code (synth :string (synth :model this))))))
  (:brief (path) (synth :req this path))
  (:model () (jarray (synth :model element)))
  (:reqlist (*) nil)
  (:form-template (loopvar indexes) 
                  (let ((new-loopvar (lower-camel (gensym "v")))
                        (new-index (lower-camel (gensym "i"))))
                    (html:div 
                     :|formArrayName| (lower-camel name)
                     (html:div :|*ngFor| (doc:text "let ~a of ~a.controls['~a'].controls; let ~a=index" 
                                                   new-loopvar 
                                                   (lower-camel loopvar)
                                                   (lower-camel name)
                                                   ;; (mapcar #'lower-camel (append* (cdr path) name))
                                                   new-index)
                               :|class| "panel panel-primary" 
                               (html:div 
                                :|class| "panel-heading" 
                                (html:span (doc:text "~a" name))
                                (html:span :|class| "glyphicon glyphicon-remove pull-right"
                                           :|(click)| (doc:hcat (doc:text "remove~aElement" (upper-camel name))
                                                                (doc:parens (apply #'doc:punctuate (doc:comma) nil
                                                                                   (mapcar (lambda (index)
                                                                                             (doc:text "~a" (lower-camel index)))
                                                                                           (append indexes (list new-index)))))) (doc:empty))) 
                               (html:div 
                                :|class| "panel-body"
                                :|[formGroupName]| new-index
                                (synth :form-template element new-loopvar (append indexes (list new-index)))))
                     (html:button :|(click)| (doc:hcat (doc:text "add~aElement" (upper-camel name))
                                                       (doc:parens (apply #'doc:punctuate (doc:comma) nil
                                                                          (mapcar (lambda (index)
                                                                                    (doc:text "~a" (lower-camel index)))
                                                                                  indexes)))) 
                                  :|type| "button"
                                  (doc:text "+" ))
                     )))
  (:form-controller (path) 
                    (let ((newpath (append path (list (list* (lower-camel (mkstr name)) 'form-array))) )
                          (newindex (gensym "i") ))
                      (ts-concat 
                       ;; (ts-comment (doc:text "~{~a ~^->~}" newpath))
                       (ts-method (doc:text "add~aElement" (upper-camel name)) 
                                  (mapcar (lambda (index)
                                            (ts-pair (car index) (ts-primitive-type 'number)))
                                          (remove-if-not (lambda (elem) (eq 'form-group (cdr elem)))
                                                         (cdr newpath)))
                                  (ts-primitive-type 'void)
                                  (ts-chain (reduce (lambda (acc elem)
                                                      (ts-chain acc 
                                                                (ts-element 'controls (ts-const (car elem))) 
                                                                :as (cdr elem)))
                                                    (cdr newpath)
                                                    :initial-value (ts-chain (ts-dynamic 'this)
                                                                             (ts-dynamic (caar newpath))))
                                            (ts-call 'push (synth :form element)
                                                     ;; (ts-chain (ts-dynamic 'this)
                                                     ;;           (ts-dynamic 'fb)
                                                     ;;           (ts-call 'group (ts-new (synth :name element))))
                                                     ))
                                  )
                       (ts-method (doc:text "remove~aElement" (upper-camel name)) 
                                  (mapcar (lambda (index)
                                            (ts-pair (car index) (ts-primitive-type 'number)))
                                          (append (remove-if-not (lambda (elem) (eq 'form-group (cdr elem)))
                                                                 (cdr newpath)) (list (list* newindex nil))))
                                  (ts-primitive-type 'void)
                                  (ts-chain (reduce (lambda (acc elem)
                                                      (ts-chain acc 
                                                                (ts-element 'controls (ts-const (car elem))) 
                                                                :as (cdr elem)))
                                                    (cdr newpath)
                                                    :initial-value (ts-chain (ts-dynamic 'this)
                                                                             (ts-dynamic (caar newpath))))
                                            (ts-call 'remove-at (ts-dynamic newindex)))

                                  )
                       (synth :form-controller element (append path (list (list* (lower-camel (mkstr name)) 'form-array)
                                                                          (list* (gensym) 'form-group))) ))))
  (:components (*) nil)
  (:routes (*) nil)
  (:form () (ts-new 'form-array (ts-array (synth :form element)))
         ;; (ts-chain (ts-dynamic 'this) (ts-dynamic 'fb)
         ;;              (ts-call 'array (ts-array (synth :form element))))
         )
  (:type () (ts-object-type 'form-array))
  (:ts-imports () (synth :ts-imports element))
  (:dependencies () (synth :dependencies element)))

(defmacro arr (name schema binds elem)
  `(let* ,(mapcar #'(lambda (bind)
		      (destructuring-bind (name key elem) bind
			`(,name (bnd ',key ,elem))))
		  binds) 
     (arr% ,name ,schema (obj% ,name ,schema (list ,@(mapcar #'car binds)) ,elem))))
